# Websockets

**WebSockets** — это протокол, который обеспечивает полнодуплексную связь между клиентом и сервером через единое соединение. В отличие от традиционного `HTTP`, где каждый запрос и ответ требуют отдельного соединения, `WebSockets` позволяют клиенту и серверу обмениваться данными в реальном времени без необходимости повторного установления соединения.

## Основные особенности WebSockets:

**- Полнодуплексная связь:** Клиент и сервер могут отправлять и получать данные одновременно.
**- Постоянное соединение:** После установления соединения, оно остается открытым до тех пор, пока одна из сторон не закроет его.
**- Низкая задержка:** Данные передаются практически мгновенно, что делает WebSockets идеальным для приложений, требующих обмена данными в реальном времени, таких как чаты, игры и финансовые приложения.

### Пример использования WebSockets на клиенте:

```javascript
// Создание нового WebSocket соединения
const socket = new WebSocket("ws://example.com/socketserver");

// Обработка события открытия соединения
socket.addEventListener("open", (event) => {
  console.log("Соединение установлено");
  socket.send("Привет, сервер!");
});

// Обработка события получения сообщения
socket.addEventListener("message", (event) => {
  console.log("Получено сообщение от сервера:", event.data);
});

// Обработка события закрытия соединения
socket.addEventListener("close", (event) => {
  console.log("Соединение закрыто");
});

// Обработка события ошибки
socket.addEventListener("error", (event) => {
  console.error("Ошибка соединения:", event);
});
```

## Основные компоненты WebSocket API:

**WebSocket объект:**

**Конструктор: new WebSocket(url, [protocols])**

`url`: URL-адрес WebSocket сервера.
`protocols`: Опциональный параметр, который указывает один или несколько подпротоколов, которые клиент хочет использовать.
Состояния `WebSocket`:
`CONNECTING` (0): Соединение устанавливается.
`OPEN` (1): Соединение установлено и готово к отправке и получению данных.
`CLOSING` (2): Соединение закрывается.
`CLOSED` (3): Соединение закрыто.

Методы `WebSocket`:

`send(data)`: Отправляет данные на сервер.
`close([code], [reason])`: Закрывает соединение.
`code`: Код закрытия (опционально).
`reason`: Причина закрытия (опционально).

Свойства `WebSocket`:

`readyState`: Текущее состояние соединения.
`bufferedAmount`: Количество байт, ожидающих отправки.
`extensions`: Строка, содержащая расширения, согласованные с сервером.
`protocol`: Строка, содержащая подпротокол, согласованный с сервером.
`url`: URL-адрес `WebSocket` сервера.

События `WebSocket`:

`open`: Соединение установлено.
`message`: Получено сообщение от сервера.
`error`: Произошла ошибка.
`close`: Соединение закрыто.

## Этапы установки соединения WebSocket:

### HTTP Handshake (Рукопожатие HTTP):

**Запрос клиента:** Клиент отправляет `HTTP`-запрос на сервер с заголовками, указывающими, что он хочет установить `WebSocket`-соединение.

```plaintext
GET /socketserver HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
```

**Ответ сервера:** Сервер отвечает с кодом статуса `101` (Switching Protocols), указывая, что он согласен на установление WebSocket-соединения.

```plaintext
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

**Sec-WebSocket-Key и Sec-WebSocket-Accept:** Эти заголовки используются для обеспечения безопасности и предотвращения атак. Клиент генерирует случайный ключ (Sec-WebSocket-Key), который сервер использует для создания ответа (Sec-WebSocket-Accept).

### Установление соединения:

    - После успешного рукопожатия HTTP-соединение переключается на WebSocket-соединение. Теперь клиент и сервер могут обмениваться данными в полнодуплексном режиме.

## Взаимодействие клиента с сервером по WebSocket:

**Отправка данных:**

Клиент и сервер могут отправлять данные друг другу в любое время после установления соединения.
Данные отправляются в виде фреймов, которые могут содержать текстовые или бинарные данные.

**Получение данных:**

Клиент и сервер могут получать данные друг от друга в любое время.
Полученные данные обрабатываются соответствующими обработчиками событий (например, message).

### Протоколы на транспортном уровне:

**TCP (Transmission Control Protocol):** WebSocket использует TCP для обеспечения надежной передачи данных. TCP гарантирует доставку данных в правильном порядке и без потерь.
`TLS (Transport Layer Security):` Для защищенных соединений (wss://) используется TLS, который обеспечивает шифрование данных и аутентификацию сервера.

## Сертификация и безопасность:

**TLS/SSL:**

Для защищенных соединений используется `TLS/SSL.` Сервер предоставляет сертификат, который подтверждает его подлинность.
Клиент проверяет сертификат сервера, чтобы убедиться, что он подключается к правильному серверу.
**Sec-WebSocket-Key и Sec-WebSocket-Accept:**

Эти заголовки используются для предотвращения атак типа "человек посередине" (MITM). Клиент генерирует случайный ключ, который сервер использует для создания ответа. Этот механизм гарантирует, что клиент и сервер действительно взаимодействуют друг с другом, а не с атакующим.

## Пример установки соединения WebSocket:

```javascript
// Клиент отправляет запрос на установление соединения:

const socket = new WebSocket("ws://example.com/socketserver");

// Сервер отвечает и устанавливает соединение:

const WebSocket = require("ws");
const wss = new WebSocket.Server({ port: 8080 });

wss.on("connection", (ws) => {
  console.log("Новый клиент подключен");
});

// Клиент и сервер обмениваются данными:

// Клиент
socket.addEventListener("open", (event) => {
  socket.send("Привет, сервер!");
});

socket.addEventListener("message", (event) => {
  console.log("Получено сообщение от сервера:", event.data);
});

// Сервер
ws.on("message", (message) => {
  console.log("Получено сообщение:", message);
  ws.send("Привет, клиент!");
});
```
